<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€¢ Pedidos</title>
  <script src="/assets/vendor/tailwindcss.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4">
    <div class="flex items-center justify-between gap-3">
      <h1 class="text-2xl font-bold">ðŸ“¦ Pedidos</h1>
      <div class="flex gap-2">
        <button id="btnReload" class="px-3 py-2 rounded bg-black text-white">Recarregar</button>
        <button id="btnLogout" class="px-3 py-2 rounded bg-white border">Sair</button>
      </div>
    </div>

    <div id="loginBox" class="mt-6 bg-white rounded-xl shadow p-4 max-w-md">
      <div class="text-sm text-gray-600 mb-3">Entre com usuÃ¡rio/senha para ver os pedidos.</div>
      <div class="grid gap-3">
        <label class="grid gap-1">
          <span class="text-sm">UsuÃ¡rio</span>
          <input id="user" class="border rounded px-3 py-2" placeholder="admin" autocomplete="username" />
        </label>
        <label class="grid gap-1">
          <span class="text-sm">Senha</span>
          <input id="pass" type="password" class="border rounded px-3 py-2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
        </label>
        <button id="btnLogin" class="px-3 py-2 rounded bg-blue-600 text-white">Entrar</button>
        <div id="loginErr" class="text-sm text-red-600 hidden"></div>
      </div>
    </div>

    <div id="panel" class="hidden mt-6">
      <div class="flex flex-col md:flex-row gap-3 items-start md:items-center justify-between">
        <div class="text-sm text-gray-600" id="stats">â€”</div>
        <div class="flex gap-2 w-full md:w-auto">
          <input id="q" class="border rounded px-3 py-2 w-full md:w-80" placeholder="Buscar por nome, whatsapp, id, cidade..." />
          <select id="limit" class="border rounded px-3 py-2">
            <option value="100">100</option>
            <option value="200" selected>200</option>
            <option value="500">500</option>
          </select>
        </div>
      </div>

      <div class="overflow-auto mt-4 bg-white rounded-xl shadow">
        <table class="min-w-full text-sm">
          <thead class="sticky top-0 bg-gray-100">
            <tr class="text-left">
              <th class="p-3">Data</th>
              <th class="p-3">ID</th>
              <th class="p-3">Cliente</th>
              <th class="p-3">Contato</th>
              <th class="p-3">EndereÃ§o</th>
              <th class="p-3">Produto</th>
              <th class="p-3">UTM</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="text-xs text-gray-500 mt-3">Dica: esses pedidos entram como <b>PIX pendente</b>. Confirme o pagamento antes de enviar. ðŸ™‚</div>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const loginBox = $("loginBox");
  const panel = $("panel");
  const loginErr = $("loginErr");
  const rows = $("rows");
  const stats = $("stats");
  const q = $("q");
  const limitSel = $("limit");

  function getAuth() { return sessionStorage.getItem("ADMIN_BASIC") || ""; }
  function setAuth(user, pass){
    const token = btoa(user + ":" + pass);
    sessionStorage.setItem("ADMIN_BASIC", "Basic " + token);
  }
  function clearAuth(){ sessionStorage.removeItem("ADMIN_BASIC"); }

  async function load(){
    rows.innerHTML = "";
    stats.textContent = "Carregando...";
    const auth = getAuth();
    const limit = limitSel.value;

    const resp = await fetch("/api/orders?limit=" + encodeURIComponent(limit), {
      headers: auth ? { "Authorization": auth } : {}
    });

    if (resp.status === 401) {
      panel.classList.add("hidden");
      loginBox.classList.remove("hidden");
      stats.textContent = "â€”";
      return;
    }

    const data = await resp.json().catch(()=>null);
    if (!data || !data.ok) {
      stats.textContent = "Erro ao carregar pedidos.";
      return;
    }

    const query = (q.value || "").toLowerCase();
    const list = (data.orders || []).filter(o => {
      if (!query) return true;
      const hay = [
        o.id, o.name, o.nome, o.phone, o.whatsapp, o.email, o.cidade, o.city,
        o.uf, o.state, o.cep, o.status, o.utm_source, o.utm_campaign
      ].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(query);
    });

    stats.textContent = `${list.length} pedidos (de ${data.count})`;
    for (const o of list) {
      const dt = o.created_at ? new Date(o.created_at) : null;
      const dtStr = dt ? dt.toLocaleString("pt-BR") : "-";
      const cliente = (o.nome || o.name || "-");
      const contato = [o.whatsapp || o.phone, o.email].filter(Boolean).join(" â€¢ ") || "-";
      const end = [
        o.address || o.endereco,
        o.number || o.numero,
        o.neighborhood || o.bairro,
        o.city || o.cidade,
        o.state || o.uf,
        o.cep
      ].filter(Boolean).join(", ") || "-";
      const prod = (o.product || o.produto || o.offer || "-");
      const utm = [
        o.utm_source && ("src=" + o.utm_source),
        o.utm_campaign && ("camp=" + o.utm_campaign),
        o.utm_content && ("cont=" + o.utm_content),
        o.utm_medium && ("med=" + o.utm_medium)
      ].filter(Boolean).join(" | ") || "-";

      const tr = document.createElement("tr");
      tr.className = "border-t";
      tr.innerHTML = `
        <td class="p-3 whitespace-nowrap">${dtStr}</td>
        <td class="p-3 whitespace-nowrap"><code class="text-xs">${o.id || "-"}</code></td>
        <td class="p-3">${escapeHtml(cliente)}</td>
        <td class="p-3">${escapeHtml(contato)}</td>
        <td class="p-3 min-w-[320px]">${escapeHtml(end)}</td>
        <td class="p-3">${escapeHtml(prod)}</td>
        <td class="p-3">${escapeHtml(utm)}</td>
      `;
      rows.appendChild(tr);
    }

    loginBox.classList.add("hidden");
    panel.classList.remove("hidden");
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  $("btnLogin").addEventListener("click", async () => {
    loginErr.classList.add("hidden");
    const user = $("user").value.trim() || "admin";
    const pass = $("pass").value;
    if (!pass) { loginErr.textContent = "Digite a senha."; loginErr.classList.remove("hidden"); return; }
    setAuth(user, pass);
    const resp = await fetch("/api/orders?limit=1", { headers: { "Authorization": getAuth() } });
    if (resp.status === 401) {
      clearAuth();
      loginErr.textContent = "UsuÃ¡rio ou senha invÃ¡lidos.";
      loginErr.classList.remove("hidden");
      return;
    }
    await load();
  });

  $("btnReload").addEventListener("click", load);
  $("btnLogout").addEventListener("click", () => { clearAuth(); location.reload(); });
  q.addEventListener("input", () => load());
  limitSel.addEventListener("change", () => load());

  // try auto-load if already logged
  load();
})();
</script>
</body>
</html>
